generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 사용자 (직원) 관리
// ============================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  role          String    @default("staff") // admin, manager, staff (하위 호환용)
  department    String?   // 하위 호환용 문자열 부서명
  phone         String?
  avatar        String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // RBAC 관계 (Phase 1-B)
  roleId        String?
  roleRef       Role?     @relation(fields: [roleId], references: [id])
  departmentId  String?
  departmentRef Department? @relation(fields: [departmentId], references: [id])
  position      String?   // 직급: 사원, 주임, 대리, 과장, 차장, 부장, 이사, 대표
  bio           String?
  lastLoginAt   DateTime?

  // 기존 관계
  customers      Customer[]
  communications Communication[]
  vocRecords     VOC[]
  activities     Activity[]
  emailTemplates EmailTemplate[]
  serviceTickets ServiceTicket[]
  shipments      Shipment[]

  // 사용자 환경설정 (1:1)
  preference     UserPreference?

  // 새 관계 (Phase 2)
  notifications       Notification[]
  posts               Post[]
  postComments        PostComment[]
  projectsOwned       Project[]       @relation("ProjectOwner")
  projectMembers      ProjectMember[]
  tasksAssigned       Task[]          @relation("TaskAssignee")
  tasksCreated        Task[]          @relation("TaskCreator")
  taskComments        TaskComment[]
  approvalsRequested  Approval[]      @relation("ApprovalRequester")
  approvalSteps       ApprovalStep[]
  calendarEvents      CalendarEvent[] @relation("EventCreator")
  eventAttendees      EventAttendee[]
  documents           Document[]
  meetingsOrganized   Meeting[]       @relation("MeetingOrganizer")
  meetingAttendees    MeetingAttendee[]
  meetingMinutes      MeetingMinute[]
  meetingActionItems  MeetingActionItem[] @relation("ActionAssignee")
  wikiPages           WikiPage[]
  channelMembers      ChannelMember[]
  messages            Message[]
}

// ============================================
// 부서 관리 (Phase 1-B)
// ============================================
model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique  // sales, research, domestic, overseas, management, marketing, design, production, as, quality, qa
  description String?
  headId      String?  // 부서장 userId
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users               User[]
  departmentPermissions DepartmentPermission[]
}

// ============================================
// 역할 관리 (Phase 1-B)
// ============================================
model Role {
  id          String   @id @default(cuid())
  name        String   @unique // 시스템관리자, 부서장, 팀장, 직원
  code        String   @unique // system_admin, dept_head, team_lead, staff
  description String?
  level       Int      @default(0) // 권한 레벨 (높을수록 높음)
  isSystem    Boolean  @default(false) // 시스템 기본 역할
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users           User[]
  rolePermissions RolePermission[]
}

// ============================================
// 권한 관리 (Phase 1-B)
// ============================================
model Permission {
  id          String   @id @default(cuid())
  module      String   // board, projects, approvals, calendar, documents, meetings, wiki, chat, reports, sales, service, customers, settings
  action      String   // read, create, update, delete, manage
  description String?
  createdAt   DateTime @default(now())

  rolePermissions       RolePermission[]
  departmentPermissions DepartmentPermission[]

  @@unique([module, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model DepartmentPermission {
  id             String     @id @default(cuid())
  departmentId   String
  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  permissionId   String
  permission     Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([departmentId, permissionId])
}

// ============================================
// 알림 시스템 (Phase 1-B)
// ============================================
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // approval, task, mention, system, board, meeting, calendar
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ============================================
// 고객 관리
// ============================================
model Customer {
  id            String    @id @default(cuid())
  name          String
  email         String?
  phone         String?
  mobile        String?
  company       String?
  position      String?
  department    String?
  address       String?
  addressDetail String?
  zipCode       String?
  grade         String    @default("normal") // vip, gold, normal, new
  status        String    @default("active") // active, inactive, dormant
  source        String?
  memo          String?
  tags          String?
  birthday      String?
  assignedToId  String?
  assignedTo    User?     @relation(fields: [assignedToId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  communications Communication[]
  vocRecords     VOC[]
  activities     Activity[]
  orders         Order[]
  serviceTickets ServiceTicket[]
  shipments      Shipment[]
}

// ============================================
// 커뮤니케이션
// ============================================
model Communication {
  id            String    @id @default(cuid())
  customerId    String
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  type          String
  direction     String
  subject       String?
  content       String
  status        String    @default("sent")
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  trackingId    String?   @unique
  metadata      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// 고객의 소리 (VOC)
// ============================================
model VOC {
  id            String    @id @default(cuid())
  customerId    String
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  category      String
  priority      String    @default("medium")
  title         String
  content       String
  status        String    @default("open")
  resolution    String?
  productTags   String?
  resolvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// 활동 로그
// ============================================
model Activity {
  id            String    @id @default(cuid())
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  type          String
  title         String
  description   String?
  dueDate       DateTime?
  isCompleted   Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// 주문/거래 내역
// ============================================
model Order {
  id            String    @id @default(cuid())
  customerId    String
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  orderNumber   String    @unique
  productName   String
  quantity      Int       @default(1)
  unitPrice     Float
  totalPrice    Float
  status        String    @default("pending")
  orderDate     DateTime  @default(now())
  memo          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// 이메일 템플릿
// ============================================
model EmailTemplate {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  name          String
  subject       String
  content       String
  category      String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// 외부 연동 설정
// ============================================
model Integration {
  id            String    @id @default(cuid())
  name          String    @unique
  type          String
  config        String?
  isActive      Boolean   @default(false)
  lastSyncAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// AS (After Service) 관리
// ============================================
model ServiceTicket {
  id              String    @id @default(cuid())
  ticketNumber    String    @unique
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  assignedToId    String?
  assignedTo      User?     @relation(fields: [assignedToId], references: [id])
  category        String
  priority        String    @default("medium")
  title           String
  description     String
  status          String    @default("received")
  productName     String?
  serialIncoming  String?
  serialOutgoing  String?
  repairCost      Float?    @default(0)
  partsCost       Float?    @default(0)
  partsUsed       String?
  receivedAt      DateTime  @default(now())
  inspectedAt     DateTime?
  repairedAt      DateTime?
  returnedAt      DateTime?
  estimatedDays   Int?
  actualDays      Int?
  returnTrackingNo  String?
  returnCourier     String?
  memo            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// 재고 관리
// ============================================
model Inventory {
  id            String    @id @default(cuid())
  sku           String    @unique
  productName   String
  category      String?
  currentStock  Int       @default(0)
  minStock      Int       @default(10)
  maxStock      Int       @default(1000)
  warehouse     String?
  unit          String    @default("EA")
  unitPrice     Float     @default(0)
  status        String    @default("in_stock")
  lastRestocked DateTime?
  memo          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  movements     InventoryMovement[]
}

// ============================================
// 재고 이동 이력
// ============================================
model InventoryMovement {
  id            String    @id @default(cuid())
  inventoryId   String
  inventory     Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  type          String
  quantity      Int
  reason        String?
  reference     String?
  teamDivision  String?
  createdAt     DateTime  @default(now())
}

// ============================================
// 배송/물류 관리
// ============================================
model Shipment {
  id              String    @id @default(cuid())
  shipmentNumber  String    @unique
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])
  type            String    @default("outbound")
  courier         String?
  trackingNumber  String?
  teamDivision    String?
  status          String    @default("preparing")
  origin          String?
  destination     String?
  items           String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  memo            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// FAQ 관리
// ============================================
model FAQ {
  id            String    @id @default(cuid())
  category      String
  question      String
  answer        String
  sortOrder     Int       @default(0)
  viewCount     Int       @default(0)
  isPublished   Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// 공지사항/게시판 (Phase 2 - 모듈 1)
// ============================================
model Post {
  id          String    @id @default(cuid())
  authorId    String
  author      User      @relation(fields: [authorId], references: [id])
  category    String    @default("general") // notice, general, department, event
  title       String
  content     String
  isPinned    Boolean   @default(false)
  isPublished Boolean   @default(true)
  viewCount   Int       @default(0)
  priority    String    @default("normal") // urgent, important, normal, low
  expiresAt   DateTime?
  attachments String?   // JSON array of file URLs
  departmentScope String? // null=전사, 특정 부서코드
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  comments    PostComment[]
}

model PostComment {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  content   String
  parentId  String?  // 답글 (대댓글)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// 프로젝트 관리 (Phase 2 - 모듈 2)
// ============================================
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("planning") // planning, active, on_hold, completed, cancelled
  priority    String   @default("medium")
  ownerId     String
  owner       User     @relation("ProjectOwner", fields: [ownerId], references: [id])
  startDate   DateTime?
  endDate     DateTime?
  progress    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     ProjectMember[]
  tasks       Task[]
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String   @default("member") // owner, admin, member, viewer
  joinedAt  DateTime @default(now())

  @@unique([projectId, userId])
}

model Task {
  id             String   @id @default(cuid())
  projectId      String
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title          String
  description    String?
  status         String   @default("todo") // todo, in_progress, review, done
  priority       String   @default("medium")
  assigneeId     String?
  assignee       User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creatorId      String
  creator        User     @relation("TaskCreator", fields: [creatorId], references: [id])
  dueDate        DateTime?
  startDate      DateTime?
  labels         String?  // JSON array
  sortOrder      Int      @default(0)
  parentId       String?  // 하위 태스크 (서브태스크)
  estimatedHours Float?   // 예상 소요 시간
  actualHours    Float?   // 실제 소요 시간
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  comments       TaskComment[]
  checklist      ChecklistItem[]
  attachments    TaskAttachment[]
  activities     TaskActivity[]
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  content   String
  createdAt DateTime @default(now())
}

// ============================================
// 태스크 체크리스트 항목
// ============================================
model ChecklistItem {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  title       String
  isCompleted Boolean  @default(false)
  sortOrder   Int      @default(0)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// 태스크 첨부파일
// ============================================
model TaskAttachment {
  id         String   @id @default(cuid())
  taskId     String
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploaderId String
  fileName   String
  fileUrl    String
  fileSize   Int      @default(0)
  mimeType   String?
  createdAt  DateTime @default(now())
}

// ============================================
// 태스크 활동 로그
// ============================================
model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  action    String   // created, status_changed, assigned, comment_added, checklist_updated, attachment_added, edited, deleted
  field     String?  // 변경된 필드명
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())
}

// ============================================
// 결재 시스템 (Phase 2 - 모듈 3)
// ============================================
model ApprovalTemplate {
  id          String   @id @default(cuid())
  name        String
  type        String   // leave, purchase, travel, expense, general
  description String?
  steps       String   // JSON: [{order, roleCode, departmentCode}]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  approvals   Approval[]
}

model Approval {
  id          String   @id @default(cuid())
  templateId  String?
  template    ApprovalTemplate? @relation(fields: [templateId], references: [id])
  requesterId String
  requester   User     @relation("ApprovalRequester", fields: [requesterId], references: [id])
  type        String   // leave, purchase, travel, expense, general
  title       String
  content     String
  status      String   @default("pending") // pending, approved, rejected, cancelled
  attachments String?  // JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  steps       ApprovalStep[]
}

model ApprovalStep {
  id         String    @id @default(cuid())
  approvalId String
  approval   Approval  @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  approverId String
  approver   User      @relation(fields: [approverId], references: [id])
  stepOrder  Int
  status     String    @default("pending") // pending, approved, rejected
  comment    String?
  decidedAt  DateTime?
  createdAt  DateTime  @default(now())
}

// ============================================
// 캘린더 (Phase 2 - 모듈 4)
// ============================================
model CalendarEvent {
  id            String    @id @default(cuid())
  title         String
  description   String?
  type          String    @default("schedule") // schedule, meeting, deadline, holiday, personal
  startDate     DateTime
  endDate       DateTime
  allDay        Boolean   @default(false)
  location      String?
  color         String?
  creatorId     String
  creator       User      @relation("EventCreator", fields: [creatorId], references: [id])
  isRecurring   Boolean   @default(false)
  recurrenceRule String?
  departmentScope String? // null=전사
  googleEventId String?   // Google Calendar 연동
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  attendees     EventAttendee[]
}

model EventAttendee {
  id       String @id @default(cuid())
  eventId  String
  event    CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId   String
  user     User   @relation(fields: [userId], references: [id])
  status   String @default("pending") // pending, accepted, declined

  @@unique([eventId, userId])
}

// ============================================
// 문서 관리 (Phase 2 - 모듈 5)
// ============================================
model DocumentFolder {
  id          String   @id @default(cuid())
  name        String
  parentId    String?
  departmentScope String? // null=공유, 부서코드=부서별
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  documents   Document[]
}

model Document {
  id          String   @id @default(cuid())
  folderId    String?
  folder      DocumentFolder? @relation(fields: [folderId], references: [id])
  uploaderId  String
  uploader    User     @relation(fields: [uploaderId], references: [id])
  name        String
  fileUrl     String
  fileSize    Int      @default(0)
  mimeType    String?
  description String?
  tags        String?
  downloadCount Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  versions    DocumentVersion[]
}

model DocumentVersion {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  version    Int
  fileUrl    String
  fileSize   Int      @default(0)
  changelog  String?
  createdAt  DateTime @default(now())
}

// ============================================
// 회의 관리 (Phase 2 - 모듈 6)
// ============================================
model Meeting {
  id          String   @id @default(cuid())
  title       String
  description String?
  organizerId String
  organizer   User     @relation("MeetingOrganizer", fields: [organizerId], references: [id])
  location    String?
  startTime   DateTime
  endTime     DateTime
  status      String   @default("scheduled") // scheduled, in_progress, completed, cancelled
  type        String   @default("general") // general, standup, review, planning, retrospective
  calendarEventId String? // 캘린더 연동
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attendees   MeetingAttendee[]
  minutes     MeetingMinute[]
  actionItems MeetingActionItem[]
}

model MeetingAttendee {
  id        String @id @default(cuid())
  meetingId String
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId    String
  user      User   @relation(fields: [userId], references: [id])
  status    String @default("pending") // pending, accepted, declined

  @@unique([meetingId, userId])
}

model MeetingMinute {
  id        String   @id @default(cuid())
  meetingId String
  meeting   Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MeetingActionItem {
  id         String    @id @default(cuid())
  meetingId  String
  meeting    Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  assigneeId String
  assignee   User      @relation("ActionAssignee", fields: [assigneeId], references: [id])
  title      String
  status     String    @default("pending") // pending, in_progress, done
  dueDate    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

// ============================================
// 위키 (Phase 2 - 모듈 7)
// ============================================
model WikiPage {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  content   String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  parentId  String?  // 트리 구조
  tags      String?  // JSON array
  sortOrder Int      @default(0)
  isPublished Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  versions  WikiVersion[]
}

model WikiVersion {
  id        String   @id @default(cuid())
  pageId    String
  page      WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  version   Int
  content   String
  changelog String?
  createdAt DateTime @default(now())
}

// ============================================
// 팀 메시지 (Phase 2 - 모듈 8)
// ============================================
model Channel {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("group") // group, direct, department
  departmentScope String?
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     ChannelMember[]
  messages    Message[]
}

model ChannelMember {
  id        String   @id @default(cuid())
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String   @default("member") // admin, member
  lastReadAt DateTime?
  joinedAt  DateTime @default(now())

  @@unique([channelId, userId])
}

model Message {
  id        String   @id @default(cuid())
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  senderId  String
  sender    User     @relation(fields: [senderId], references: [id])
  content   String
  type      String   @default("text") // text, file, system
  fileUrl   String?
  fileName  String?
  isEdited  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// 리포트 템플릿 (Phase 2 - 모듈 9)
// ============================================
model ReportTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   // sales, service, customer, inventory, project
  config      String   // JSON: 차트 설정, 필터 등
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// 사용자 환경설정 (개인화)
// ============================================
model UserPreference {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme           String   @default("light") // light, dark
  language        String   @default("ko")
  emailNotify     Boolean  @default(true)
  pushNotify      Boolean  @default(true)
  taskReminder    Boolean  @default(true)
  approvalNotify  Boolean  @default(true)
  chatNotify      Boolean  @default(true)
  hiddenWidgets   String?  // JSON array of widget keys to hide
  dashboardLayout String?  // JSON layout config
  sidebarCollapsed Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// 시스템 전체 설정 (키-값)
// ============================================
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String   @default("general") // general, email, security, display
  description String?
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// AI CS 시스템 (멀티 에이전트)
// ============================================

// AI 대화 세션
model AIConversation {
  id          String    @id @default(cuid())
  userId      String
  customerId  String?
  ticketId    String?
  status      String    @default("active") // active, resolved, escalated, closed
  language    String    @default("ko")
  sentiment   String?   // positive, neutral, negative, angry
  priority    String    @default("medium") // low, medium, high, urgent
  category    String?   // faq, error, hardware, policy, general
  summary     String?
  metadata    String?   // JSON
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  messages    AIMessage[]
  agentLogs   AIAgentLog[]
  feedbacks   AIFeedback[]
}

// AI 대화 메시지
model AIMessage {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role            String   // user, assistant, system
  content         String
  agentId         String?  // 응답한 에이전트 ID (team-1 ~ team-10)
  agentName       String?  // 에이전트 이름
  isReviewed      Boolean  @default(false)
  isApproved      Boolean? // null=미검토, true=승인, false=반려
  reviewNote      String?
  tokenInput      Int      @default(0)
  tokenOutput     Int      @default(0)
  metadata        String?  // JSON (감정분석 결과, 번역 등)
  createdAt       DateTime @default(now())
}

// AI 에이전트 실행 로그
model AIAgentLog {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  agentId         String   // team-1 ~ team-10
  agentName       String
  action          String   // classify, translate, analyze, search, diagnose, review, etc.
  input           String?  // 입력 요약
  output          String?  // 출력 요약
  confidence      Float?   // 0.0 ~ 1.0
  durationMs      Int      @default(0)
  tokenUsage      Int      @default(0)
  error           String?
  createdAt       DateTime @default(now())
}

// AI 사용자 피드백
model AIFeedback {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  messageId       String?
  userId          String
  rating          Int      // 1-5
  feedbackType    String   @default("general") // general, accuracy, speed, helpfulness
  comment         String?
  createdAt       DateTime @default(now())
}

// AI 에이전트 설정
model AIAgentConfig {
  id              String   @id @default(cuid())
  agentId         String   @unique // team-1 ~ team-10
  agentName       String
  description     String?
  systemPrompt    String?  // 커스텀 시스템 프롬프트 (null이면 기본값 사용)
  temperature     Float    @default(0.3)
  maxTokens       Int      @default(2000)
  isEnabled       Boolean  @default(true)
  priority        Int      @default(0) // 호출 우선순위
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// AI 일별 사용량 집계
model AIUsageDaily {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  agentId         String?  // null이면 전체 합산
  totalCalls      Int      @default(0)
  totalTokenInput Int      @default(0)
  totalTokenOutput Int     @default(0)
  totalMessages   Int      @default(0)
  totalConversations Int   @default(0)
  estimatedCostUsd Float   @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([date, agentId])
}
